[
  {
    "objectID": "n_schools_pf.html#introduction",
    "href": "n_schools_pf.html#introduction",
    "title": "Behavior of N Schools Problem with Pathfinder",
    "section": "Introduction",
    "text": "Introduction\nDuring our investigation of using Pathfinder to fit hierarchical models, we found that pathfinder produced duplicated rows in the sample. This document reproduces the problem and shows that as the dimension of the parameter space increases, there are fewer and fewer distinct rows generated by the sample. We use the 8-Schools model to demonstrate the row duplication in the simple case. We then generate new data to extend the problem to \\(N\\) schools to show that the number of number of distinct rows decreases as the dimension increases. We make no claims to the cause of this at the moment."
  },
  {
    "objectID": "n_schools_pf.html#software-versions",
    "href": "n_schools_pf.html#software-versions",
    "title": "Behavior of N Schools Problem with Pathfinder",
    "section": "Software Versions",
    "text": "Software Versions\nIn this demo we are using R version 4.4.1 (2024-06-14) with CmdStan version 2.35.0 and cmdstanr version 0.8.1."
  },
  {
    "objectID": "n_schools_pf.html#pathfinder-with-the-non-centered-8-schools-model",
    "href": "n_schools_pf.html#pathfinder-with-the-non-centered-8-schools-model",
    "title": "Behavior of N Schools Problem with Pathfinder",
    "section": "Pathfinder with the (non-centered) 8 Schools Model",
    "text": "Pathfinder with the (non-centered) 8 Schools Model\nWe first investigate the behavior of the 8-Schools.\n\nlibrary(cmdstanr)\nlibrary(jsonlite)\nlibrary(tidyverse)\nlibrary(glue)\n\nWe use the following data:\n\n#read in data\nstan_data &lt;- read_json( \"eight_schools.json\", simplifyVector=T)\nprint(stan_data)\n\n$J\n[1] 8\n\n$y\n[1] 28  8 -3  7 -1  1 18 12\n\n$sigma\n[1] 15 10 16 11  9 11 10 18\n\n\nAnd use the stan script below to run our model.\n\n\ndata {\n  int &lt;lower=0&gt; J; // number of schools\n  array[J] real y; // estimated treatment\n  array[J] real&lt;lower=0&gt; sigma; // std of estimated effect\n}\nparameters {\n  vector[J] theta_trans; // transformation of theta\n  real mu; // hyper-parameter of mean\n  real&lt;lower=0&gt; tau; // hyper-parameter of sd\n}\ntransformed parameters{\n  vector[J] theta;\n  // original theta\n  theta=theta_trans*tau+mu;\n}\nmodel {\n  theta_trans ~ normal (0,1);\n  y ~ normal(theta , sigma);\n  mu ~ normal(0, 5); // a non-informative prior\n  tau ~ cauchy(0, 5);\n}\n\n\nNext, we run the 8-Schools model and extract draws to observe the number of distinct rows in the sample.\n\n#### Run eight schools non-centered version\nmod_eight    &lt;- cmdstanr::cmdstan_model( \"eight_schools_noncentered.stan\",\n                                        cpp_options=list(stan_threads=TRUE)) \n\nfit_eight &lt;- mod_eight$pathfinder( data = stan_data,\n                       refresh = 8,\n                       draws=2000,\n                       num_threads = 8,\n                       num_paths = 20,\n                       psis_resample = T \n                       )\n\nPath [1] :Initial log joint density = -8.357889 \nPath [11] :Initial log joint density = -9.156772 \nPath [16] :Initial log joint density = -7.329353 \nPath [1] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n              7      -8.300e-01      7.939e-02   3.989e-01    8.265e-01  8.265e-01       176 -4.245e+01 -4.245e+01                   \nPath [13] :Initial log joint density = -7.749789 \nPath [12] :Initial log joint density = -11.358032 \nPath [18] :Initial log joint density = -8.866323 \nPath [11] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n              7      -8.466e-01      8.903e-02   5.918e-01    5.037e-01  5.037e-01       176 -5.014e+01 -5.014e+01                   \nPath [1] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             15      -7.960e-01      1.620e-02   3.251e-02    1.000e+00  1.000e+00       376 -4.032e+01 -4.032e+01                   \nPath [19] :Initial log joint density = -5.612892 \nPath [14] :Initial log joint density = -9.612952 \nPath [16] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n              7      -8.506e-01      3.522e-01   5.578e-01    1.000e+00  1.000e+00       176 -8.836e+01 -8.836e+01                   \nPath [13] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n              7      -8.190e-01      3.606e-01   4.603e-01    9.440e-01  9.440e-01       176 -6.098e+01 -6.098e+01                   \nPath [11] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             15      -8.071e-01      7.562e-02   7.340e-02    1.000e+00  1.000e+00       376 -1.134e+02 -1.134e+02                   \nPath [12] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n              7      -8.455e-01      2.236e-01   1.074e+00    1.000e+00  1.000e+00       176 -4.250e+01 -4.250e+01                   \nPath [18] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n              7      -8.427e-01      2.469e-01   4.555e-01    1.000e+00  1.000e+00       176 -4.003e+01 -4.003e+01                   \nPath [1] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             23      -7.949e-01      3.408e-03   2.497e-03    6.759e-01  6.759e-01       576 -4.392e+01 -4.392e+01                   \nPath [16] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             15      -8.086e-01      4.182e-01   2.092e-01    1.000e+00  1.000e+00       376 -5.320e+01 -5.320e+01                   \nPath [19] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n              7      -8.493e-01      1.527e-01   2.334e-01    6.456e-01  6.456e-01       176 -6.487e+01 -6.487e+01                   \nPath [1] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             26      -7.949e-01      7.045e-05   1.293e-04    8.979e-01  8.979e-01       651 -4.580e+01 -4.580e+01                   \nPath [1] :Best Iter: [14] ELBO (-39.340545) evaluations: (651) \nPath [14] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n              7      -8.198e-01      2.532e-01   4.508e-01    1.000e+00  1.000e+00       176 -4.525e+01 -4.525e+01                   \nPath [12] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             15      -7.951e-01      7.958e-04   9.091e-03    5.421e-01  5.421e-01       376 -4.045e+01 -4.045e+01                   \nPath [13] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             15      -7.962e-01      5.498e-02   5.454e-02    1.000e+00  1.000e+00       376 -4.117e+01 -4.117e+01                   \nPath [11] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             23      -7.949e-01      8.353e-04   1.209e-03    8.955e-01  8.955e-01       576 -4.024e+01 -4.024e+01                   \nPath [18] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             15      -7.949e-01      3.025e-04   6.348e-04    1.000e+00  1.000e+00       376 -4.789e+01 -4.789e+01                   \nPath [11] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             27      -7.949e-01      6.100e-05   1.070e-04    9.482e-01  9.482e-01       676 -4.648e+01 -4.648e+01                   \nPath [11] :Best Iter: [1] ELBO (-34.236396) evaluations: (676) \nPath [16] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             23      -7.949e-01      2.333e-04   2.627e-04    1.000e+00  1.000e+00       576 -4.061e+01 -4.061e+01                   \nPath [19] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             15      -8.086e-01      3.269e-01   3.319e-01    5.229e-01  1.000e+00       376 -4.105e+01 -4.105e+01                   \nPath [14] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             15      -7.949e-01      1.423e-04   6.344e-04    1.000e+00  1.000e+00       376 -4.565e+01 -4.565e+01                   \nPath [12] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             23      -7.949e-01      3.062e-03   2.048e-03    1.000e+00  1.000e+00       576 -4.939e+01 -4.939e+01                   \nPath [18] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             23      -7.949e-01      4.180e-04   4.915e-04    1.000e+00  1.000e+00       576 -4.687e+01 -4.687e+01                   \nPath [13] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             23      -7.949e-01      1.933e-04   7.589e-04    2.656e-01  1.000e+00       576 -8.130e+01 -8.130e+01                   \nPath [18] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             25      -7.949e-01      4.484e-05   3.720e-05    9.993e-01  9.993e-01       626 -4.162e+01 -4.162e+01                   \nPath [18] :Best Iter: [1] ELBO (-35.447918) evaluations: (626) \nPath [13] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             25      -7.949e-01      2.179e-04   3.097e-05    1.000e+00  1.000e+00       626 -4.461e+01 -4.461e+01                   \nPath [13] :Best Iter: [5] ELBO (-39.620462) evaluations: (626) \nPath [16] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             29      -7.949e-01      3.539e-05   4.940e-05    7.688e-01  7.688e-01       726 -3.886e+01 -3.886e+01                   \nPath [16] :Best Iter: [3] ELBO (-37.988541) evaluations: (726) \nPath [12] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             28      -7.949e-01      3.262e-04   6.243e-05    1.000e+00  1.000e+00       701 -4.901e+01 -4.901e+01                   \nPath [12] :Best Iter: [1] ELBO (-34.741750) evaluations: (701) \nPath [19] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             23      -7.949e-01      1.663e-03   5.856e-03    3.766e-01  1.000e+00       576 -4.758e+01 -4.758e+01                   \nPath [14] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             23      -7.949e-01      2.603e-04   6.328e-04    9.220e-01  9.220e-01       576 -8.769e+01 -8.769e+01                   \nPath [14] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             27      -7.949e-01      5.012e-05   8.312e-06    1.000e+00  1.000e+00       676 -4.013e+01 -4.013e+01                   \nPath [14] :Best Iter: [1] ELBO (-34.228154) evaluations: (676) \nPath [19] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             31      -7.949e-01      1.463e-04   1.356e-05    1.000e+00  1.000e+00       776 -6.061e+01 -6.061e+01                   \nPath [19] :Best Iter: [1] ELBO (-34.593565) evaluations: (776) \nPath [2] :Initial log joint density = -11.792480 \nPath [15] :Initial log joint density = -9.831626 \nPath [2] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n              7      -9.265e-01      1.496e-01   6.741e-01    5.278e-01  5.278e-01       176 -1.100e+02 -1.100e+02                   \nPath [6] :Initial log joint density = -10.498559 \nPath [8] :Initial log joint density = -16.637050 \nPath [15] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n              7      -8.427e-01      2.790e-01   3.597e-01    9.080e-01  9.080e-01       176 -5.302e+01 -5.302e+01                   \nPath [7] :Initial log joint density = -9.920865 \nPath [17] :Initial log joint density = -5.603996 \nPath [2] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             15      -7.949e-01      1.135e-03   1.394e-03    1.000e+00  1.000e+00       376 -4.310e+01 -4.310e+01                   \nPath [20] :Initial log joint density = -10.291686 \nPath [6] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n              7      -8.492e-01      2.718e-01   4.254e-01    7.063e-01  7.063e-01       176 -4.360e+01 -4.360e+01                   \nPath [15] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             15      -7.954e-01      2.484e-01   8.165e-02    9.362e-01  9.362e-01       376 -4.876e+01 -4.876e+01                   \nPath [8] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n              7      -1.117e+00      4.494e-01   9.258e-01    2.989e-01  2.989e-01       176 -4.871e+01 -4.871e+01                   \nPath [3] :Initial log joint density = -10.999029 \nPath [7] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n              7      -8.417e-01      1.536e-01   3.212e-01    8.437e-01  8.437e-01       176 -4.571e+01 -4.571e+01                   \nPath [17] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n              7      -8.731e-01      2.131e-01   4.404e-01    5.036e-01  9.126e-01       176 -5.111e+01 -5.111e+01                   \nPath [2] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             23      -7.949e-01      4.037e-04   2.839e-04    1.000e+00  1.000e+00       576 -4.268e+01 -4.268e+01                   \nPath [6] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             15      -8.068e-01      1.881e-01   3.321e-01    2.289e-01  1.000e+00       376 -4.506e+01 -4.506e+01                   \nPath [15] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             22      -7.949e-01      2.986e-05   1.341e-04    4.662e-01  9.619e-01       551 -1.204e+02 -1.204e+02                   \nPath [15] :Best Iter: [1] ELBO (-33.861601) evaluations: (551) \nPath [8] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             15      -7.971e-01      3.234e-02   4.581e-02    1.000e+00  1.000e+00       376 -4.321e+01 -4.321e+01                   \nPath [20] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n              7      -8.051e-01      3.067e-02   1.408e-01    4.402e-01  4.402e-01       176 -4.999e+01 -4.999e+01                   \nPath [2] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             26      -7.949e-01      5.570e-05   8.517e-05    8.594e-01  8.594e-01       651 -5.448e+01 -5.448e+01                   \nPath [2] :Best Iter: [1] ELBO (-35.436028) evaluations: (651) \nPath [3] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n              7      -8.570e-01      4.221e-02   7.008e-01    4.417e-01  4.417e-01       176 -3.945e+01 -3.945e+01                   \nPath [7] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             15      -8.038e-01      2.369e-01   2.795e-01    4.460e-01  1.000e+00       376 -4.559e+01 -4.559e+01                   \nPath [17] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             15      -8.034e-01      4.759e-01   2.685e-01    1.000e+00  1.000e+00       376 -9.610e+01 -9.610e+01                   \nPath [6] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             23      -7.949e-01      2.412e-03   9.987e-03    1.934e-01  1.000e+00       576 -4.358e+01 -4.358e+01                   \nPath [8] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             23      -7.949e-01      1.825e-03   4.031e-03    1.000e+00  1.000e+00       576 -7.882e+01 -7.882e+01                   \nPath [20] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             15      -7.980e-01      4.249e-02   6.935e-02    1.000e+00  1.000e+00       376 -1.549e+02 -1.549e+02                   \nPath [8] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             25      -7.949e-01      3.187e-04   1.019e-04    9.589e-01  9.589e-01       626 -4.695e+01 -4.695e+01                   \nPath [3] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             15      -8.059e-01      1.007e-01   1.689e-01    5.357e-01  5.357e-01       376 -1.952e+02 -1.952e+02                   \nPath [8] :Best Iter: [2] ELBO (-34.762770) evaluations: (626) \nPath [7] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             23      -7.949e-01      1.754e-04   1.574e-04    1.000e+00  1.000e+00       576 -5.014e+01 -5.014e+01                   \nPath [7] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             24      -7.949e-01      2.157e-05   7.971e-05    1.000e+00  1.000e+00       601 -4.121e+01 -4.121e+01                   \nPath [7] :Best Iter: [1] ELBO (-38.733646) evaluations: (601) \nPath [17] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             23      -7.949e-01      1.030e-03   1.561e-03    1.000e+00  1.000e+00       576 -7.500e+01 -7.500e+01                   \nPath [6] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             30      -7.949e-01      1.933e-03   8.430e-05    1.000e+00  1.000e+00       751 -5.381e+01 -5.381e+01                   \nPath [6] :Best Iter: [1] ELBO (-33.888844) evaluations: (751) \nPath [20] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             23      -7.949e-01      3.215e-03   2.824e-03    8.371e-01  8.371e-01       576 -4.864e+01 -4.864e+01                   \nPath [17] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             26      -7.949e-01      1.098e-04   9.475e-05    8.518e-01  8.518e-01       651 -7.051e+01 -7.051e+01                   \nPath [17] :Best Iter: [1] ELBO (-34.809170) evaluations: (651) \nPath [3] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             23      -7.949e-01      8.950e-05   1.365e-04    1.000e+00  1.000e+00       576 -4.384e+01 -4.384e+01                   \nPath [20] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             26      -7.949e-01      3.112e-05   1.190e-04    4.686e-01  9.837e-01       651 -4.089e+01 -4.089e+01                   \nPath [20] :Best Iter: [1] ELBO (-34.233499) evaluations: (651) \nPath [3] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             24      -7.949e-01      4.133e-05   2.913e-05    1.000e+00  1.000e+00       601 -3.821e+01 -3.821e+01                   \nPath [3] :Best Iter: [1] ELBO (-33.682115) evaluations: (601) \nPath [9] :Initial log joint density = -6.333818 \nPath [4] :Initial log joint density = -5.378825 \nPath [9] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n              7      -8.005e-01      2.501e-01   1.816e-01    1.000e+00  1.000e+00       176 -5.434e+01 -5.434e+01                   \nPath [4] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n              7      -8.287e-01      4.082e-02   1.791e-01    3.077e-01  3.077e-01       176 -6.013e+01 -6.013e+01                   \nPath [5] :Initial log joint density = -11.207934 \nPath [10] :Initial log joint density = -10.504087 \nPath [9] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             15      -7.956e-01      9.576e-02   9.741e-02    4.301e-01  1.000e+00       376 -3.865e+01 -3.865e+01                   \nPath [4] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             15      -7.990e-01      1.382e-01   2.322e-01    4.315e-01  4.315e-01       376 -4.061e+01 -4.061e+01                   \nPath [5] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n              7      -8.894e-01      2.515e-01   1.307e+00    5.047e-01  5.047e-01       176 -4.384e+01 -4.384e+01                   \nPath [10] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n              7      -8.106e-01      5.466e-02   2.478e-01    5.245e-01  5.245e-01       176 -4.122e+01 -4.122e+01                   \nPath [9] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             23      -7.949e-01      1.192e-04   1.868e-04    1.000e+00  1.000e+00       576 -5.966e+01 -5.966e+01                   \nPath [5] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             15      -7.952e-01      1.403e-03   5.554e-03    1.000e+00  1.000e+00       376 -4.659e+01 -4.659e+01                   \nPath [4] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             23      -7.949e-01      4.016e-04   1.307e-03    9.512e-01  9.512e-01       576 -5.901e+01 -5.901e+01                   \nPath [9] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             26      -7.949e-01      3.577e-05   1.175e-04    2.765e-01  2.765e-01       651 -4.054e+01 -4.054e+01                   \nPath [9] :Best Iter: [15] ELBO (-38.652918) evaluations: (651) \nPath [4] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             25      -7.949e-01      7.972e-05   5.916e-05    1.000e+00  1.000e+00       626 -4.049e+01 -4.049e+01                   \nPath [10] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             15      -7.957e-01      4.431e-02   3.987e-02    1.000e+00  1.000e+00       376 -1.091e+02 -1.091e+02                   \nPath [4] :Best Iter: [16] ELBO (-38.721072) evaluations: (626) \nPath [5] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             23      -7.949e-01      8.878e-03   1.479e-03    1.000e+00  1.000e+00       576 -6.119e+01 -6.119e+01                   \nPath [10] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             23      -7.949e-01      3.500e-04   2.629e-04    1.000e+00  1.000e+00       576 -4.862e+01 -4.862e+01                   \nPath [10] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             25      -7.949e-01      1.643e-05   1.110e-04    5.039e-01  5.039e-01       626 -4.203e+01 -4.203e+01                   \nPath [10] :Best Iter: [21] ELBO (-40.265043) evaluations: (626) \nPath [5] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  \n             28      -7.949e-01      7.324e-04   7.125e-05    9.423e-01  9.423e-01       701 -7.641e+01 -7.641e+01                   \nPath [5] :Best Iter: [1] ELBO (-35.284932) evaluations: (701) \nTotal log probability function evaluations:32645 \nPareto k value (0.98) is greater than 0.7. Importance resampling was not able to improve the approximation, which may indicate that the approximation itself is poor. \nFinished in  0.2 seconds.\n\n\nAfter running pathfinder, we check the number of distinct draws in the output\n\neight_df &lt;- fit_eight$draws(format=\"df\")\n\n#get number of distinct rows from output\nd_rows &lt;- eight_df %&gt;% select(-.chain, -.iteration, -.draw) %&gt;% distinct() %&gt;% nrow()\n\n#get total number of rows\nrows &lt;- nrow(eight_df)\n\nWe note that there were 954 distinct rows out of 2000 total rows."
  },
  {
    "objectID": "n_schools_pf.html#generating-new-schools",
    "href": "n_schools_pf.html#generating-new-schools",
    "title": "Behavior of N Schools Problem with Pathfinder",
    "section": "Generating “New Schools”",
    "text": "Generating “New Schools”\nAfter reviewing the 8-Schools model, we wanted to investigate how increasing the number of schools affected the number of distinct draws from pathfinder. We did so by modeling the original 8-schools data set. In our model, we parameterize the variance along with the mean. Our goal is to then generate N schools and model them via Pathfinder.\nWe use the following stan script:\n\n\ndata {\n  int &lt;lower=0&gt; J; // number of schools\n  array[J] real y; // estimated treatment\n  array[J] real&lt;lower=0&gt; sigma; // std of estimated effect\n}\ntransformed data{\n  array[J] real&lt;lower=0&gt; sigma_2;\n  sigma_2 = pow(sigma,2);\n}\nparameters {\n  vector[J] theta_trans; // transformation of theta\n  real mu; // hyper-parameter of mean\n  real&lt;lower=0&gt; tau; // hyper-parameter of sd\n  real&lt;lower=0&gt; phi;\n}\ntransformed parameters{\n  vector[J] theta;   \n  real&lt;lower=0&gt; sqrt_phi;\n  real&lt;lower=0&gt; tau_sq;\n  // original theta\n  theta=theta_trans*tau+mu;\n  sqrt_phi = sqrt(phi);\n  tau_sq = pow(tau,2);\n}\nmodel {\n  theta_trans ~ normal (0,1);\n  y ~ normal(theta , sqrt_phi);\n  sigma_2 ~ inv_gamma(2, phi ); \n  mu ~ normal(0, 5); // a non-informative prior\n  tau ~ cauchy(0, 5);\n  phi ~ gamma(1,1);\n}\n\n\nNext we run the model using HMC to get the parameter estimates we will use later to generate new data.\n\n#### Run eight schools non-centered version\nsuppressWarnings(mod1     &lt;- cmdstanr::cmdstan_model( \"eight_schools_noncentered_gvf.stan\",\n                                                    cpp_options=list(stan_threads=TRUE) ) )\n\n#Fit our new model to 8-schools with HMC \nfit_samp = mod1$sample( data = stan_data, \n                         chains=3, \n                         threads_per_chain=1,\n                         refresh=300,\n                         adapt_delta = .99 )\n\nRunning MCMC with 3 sequential chains, with 1 thread(s) per chain...\n\nChain 1 Iteration:    1 / 2000 [  0%]  (Warmup) \nChain 1 Iteration:  300 / 2000 [ 15%]  (Warmup) \nChain 1 Iteration:  600 / 2000 [ 30%]  (Warmup) \nChain 1 Iteration:  900 / 2000 [ 45%]  (Warmup) \nChain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) \nChain 1 Iteration: 1300 / 2000 [ 65%]  (Sampling) \nChain 1 Iteration: 1600 / 2000 [ 80%]  (Sampling) \nChain 1 Iteration: 1900 / 2000 [ 95%]  (Sampling) \nChain 1 Iteration: 2000 / 2000 [100%]  (Sampling) \nChain 1 finished in 0.2 seconds.\nChain 2 Iteration:    1 / 2000 [  0%]  (Warmup) \nChain 2 Iteration:  300 / 2000 [ 15%]  (Warmup) \nChain 2 Iteration:  600 / 2000 [ 30%]  (Warmup) \nChain 2 Iteration:  900 / 2000 [ 45%]  (Warmup) \nChain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) \nChain 2 Iteration: 1300 / 2000 [ 65%]  (Sampling) \nChain 2 Iteration: 1600 / 2000 [ 80%]  (Sampling) \nChain 2 Iteration: 1900 / 2000 [ 95%]  (Sampling) \nChain 2 Iteration: 2000 / 2000 [100%]  (Sampling) \nChain 2 finished in 0.2 seconds.\nChain 3 Iteration:    1 / 2000 [  0%]  (Warmup) \nChain 3 Iteration:  300 / 2000 [ 15%]  (Warmup) \nChain 3 Iteration:  600 / 2000 [ 30%]  (Warmup) \nChain 3 Iteration:  900 / 2000 [ 45%]  (Warmup) \nChain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) \nChain 3 Iteration: 1300 / 2000 [ 65%]  (Sampling) \nChain 3 Iteration: 1600 / 2000 [ 80%]  (Sampling) \nChain 3 Iteration: 1900 / 2000 [ 95%]  (Sampling) \nChain 3 Iteration: 2000 / 2000 [100%]  (Sampling) \nChain 3 finished in 0.1 seconds.\n\nAll 3 chains finished successfully.\nMean chain execution time: 0.2 seconds.\nTotal execution time: 0.8 seconds.\n\n\nFinally, we obtain the following parameter estimates that will be used in the next section\n\nmydraws &lt;- fit_samp$draws(format=\"df\")\n\nlibrary(invgamma)\n\nmu_bar &lt;- mydraws$mu   %&gt;% mean()\ntausq_bar &lt;- mydraws$tau_sq %&gt;% mean()\nphi_bar &lt;- mydraws$phi %&gt;% mean()\n\n\ncat(\"****Parameters Estimated From Model****\",\"\\n\",\n    \"mu_bar:\",mu_bar,\"\\n\",\n    \"tausq_bar:\", tausq_bar,\"\\n\",\n    \"phi_bar:\", phi_bar)\n\n****Parameters Estimated From Model**** \n mu_bar: 5.49019 \n tausq_bar: 115.9907 \n phi_bar: 16.26327"
  },
  {
    "objectID": "n_schools_pf.html#fitting-n-schools",
    "href": "n_schools_pf.html#fitting-n-schools",
    "title": "Behavior of N Schools Problem with Pathfinder",
    "section": "Fitting N Schools",
    "text": "Fitting N Schools\n\nOur Procedure\nWe will run the N school problem from 8 to 150 schools by 2, 10 times each using the parameters we found from HMC. For each simulation, we generate new data as shown below.\n\nN &lt;- x\nsigma &lt;- rinvgamma(N, 2, scale = phi_bar) \ntheta &lt;- rnorm(N, mu_bar, tausq_bar )\ny     &lt;- rnorm(theta,phi_bar)\n\nWe then run pathfinder using the call below.\n\n#run pathfinder\nfit_pf = mod_eight$pathfinder( data =  temp[[k]][['stan_data_gen']],\n                   draws=3000,\n                   num_threads = 12,\n                   num_paths = 20,\n                   psis_resample = T)  \n\nAfter each iteration of the loop, we store the model fit and the draws. We will perform analysis on this afterwards.\n\n\nMain Loop\nWe perform the steps noted in the previous section in the main loop below.\nWe run the model for 8 to 150 schools by 2, 10 times each.\n\nlibrary(parallel)\n\n\n#status file just helps us keep track of progress\nfile.remove(\"status.txt\")\n\n[1] TRUE\n\n#N_tot is a sequence of number of schools \n#we will generate\nN_tot &lt;- seq(from=8, to=150, by=2)\n\n#for each number of \nn_times &lt;- 10\n\n\n#function I will use in an lapply\nmyloop &lt;- function(x){\n    \n    #store the n_times simulations\n    temp &lt;- list()\n    \n    #begin simulating n_times\n    for(k in 1:n_times){\n        \n        #this is simply here for me to keep track of the simulation\n        write_lines( x = paste0(\"Number of Schools: \",x,\" Simulation Number: \", k),\n                    file= \"status.txt\",\n                    append=T )\n        \n        #create a holder for this \n        #simulations results\n        temp[[k]] &lt;- list()       \n        \n        #Generate New Data\n        N &lt;- x\n        sigma &lt;- rinvgamma(N, 2, scale = phi_bar) \n        theta &lt;- rnorm(N, mu_bar, tausq_bar )\n        y     &lt;- rnorm(theta,phi_bar)\n\n        #store the data we will use\n        temp[[k]][['stan_data_gen']] &lt;- list(J=N,y=y,sigma=sigma)\n        \n        #run pathfinder\n        fit_pf = mod_eight$pathfinder( data =  temp[[k]][['stan_data_gen']],\n                           draws=3000,\n                           refresh=0,\n                           num_threads = 4,\n                           num_paths = 20,\n                           psis_resample = T)  \n        \n        #store the model\n        temp[[k]][['model']] &lt;- fit_pf\n        temp[[k]][['draws']] &lt;- fit_pf$draws(format=\"df\")\n    }\n    \n    return( temp )\n}\n\n#run simulation\n#results &lt;- lapply(N_tot,myloop)  #I use this on Windows\nresults &lt;- mclapply(N_tot,myloop,mc.preschedule=F,mc.cores=40)\n\nAfter running the simulation, we extract the number of schools in each simulation along with the number of unique draws from the simulation.\n\n #number of schools in each simulation\n nschools  &lt;- results %&gt;% map( ~map_int( .x, ~pluck(.x,\"stan_data_gen\",\"J\") )) %&gt;% list_c()\n\n #return number of unique\n getdistinctdraws &lt;- . %&gt;% \n                      select(-.chain, -.iteration, -.draw) %&gt;% \n                      distinct() %&gt;% \n                      nrow()\n \n #get number of distinct samples in each simulation\n uniquedraws &lt;- results %&gt;% \n             map( ~map_int( .x, ~( pluck(.x,\"draws\") %&gt;% getdistinctdraws) )) %&gt;% \n             list_c()\n\n df_summary &lt;- tibble(nschools = as.factor(nschools), \n                      n_unique_draws = uniquedraws)\n\nFinally we plot a violin plot of the number of unique rows.\n\nlibrary(scales)\n\n\nAttaching package: 'scales'\n\n\nThe following object is masked from 'package:purrr':\n\n    discard\n\n\nThe following object is masked from 'package:readr':\n\n    col_factor\n\ndf_summary %&gt;% ggplot(aes(x=nschools,y=n_unique_draws)) + \n               geom_boxplot() + \n               scale_x_discrete(breaks=c(seq(from=8,to=150,by=6),150)) +\n               labs(title=\"Number of Unique Rows Out of 3000 Draws \\nby Number of Schools in Simulation\",\n                    y = \"Number of Unique Draws\", \n                    x=\"Number of Schools in Simulation\") + \n               theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1,size=10))"
  }
]